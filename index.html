<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Twilio Voice Web Client</title>
  <style>
    body { font-family: sans-serif; max-width: 480px; margin: 2rem auto; }
    textarea { width: 100%; height: 120px; }
    button { padding: 0.6rem 1.2rem; margin-right: 0.5rem; }
    #status { margin: 1rem 0; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Voice Test</h1>
  <div>
    <label>
      Identity (optional):
      <input id="identity" type="text" placeholder="web-agent-1" />
    </label>
  </div>
  <div>
    <label>
      Dial To (e.g., agent SIP/number):
      <input id="dial-to" type="text" placeholder="+15551234567" />
    </label>
  </div>
  <div id="status">Device not initialized</div>
  <button id="initBtn">Initialize Device</button>
  <button id="callBtn" disabled>Call</button>
  <button id="hangupBtn" disabled>Hang up</button>
  <h3>Logs</h3>
  <textarea id="log" readonly></textarea>

  <!-- Twilio Voice SDK (v1.x) -->
  <script src="https://sdk.twilio.com/js/client/v1.13/twilio.min.js"></script>
  <script>
    const TOKEN_ENDPOINT = "https://magnet-essentially-focuses-mile.trycloudflare.com/api/v1/telephony/access-token";
    const logEl = document.getElementById("log");
    const statusEl = document.getElementById("status");
    const initBtn = document.getElementById("initBtn");
    const callBtn = document.getElementById("callBtn");
    const hangupBtn = document.getElementById("hangupBtn");

    let device;
    let activeConnection = null;

    function log(message) {
      logEl.value = `${new Date().toISOString()} - ${message}\n${logEl.value}`;
    }

    async function getToken(identity) {
      const body = identity ? JSON.stringify({ identity }) : "{}";

      const response = await fetch(TOKEN_ENDPOINT, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body,
      });

      if (!response.ok) {
        const text = await response.text();
        throw new Error(`Token request failed: ${response.status} ${text}`);
      }
      const data = await response.json();
      return data.token;
    }

    async function initDevice() {
      statusEl.textContent = "Requesting token...";
      try {
        const identity = document.getElementById("identity").value.trim();
        const token = await getToken(identity);

        device = new Twilio.Device(token, {
          codecPreferences: ["opus", "pcmu"],
          fakeLocalDTMF: true,
          enableRingingState: true,
        });

        device.on("ready", () => {
          statusEl.textContent = `Device ready (identity: ${device.identity})`;
          log("Device ready");
          callBtn.disabled = false;
        });

        device.on("error", (error) => {
          statusEl.textContent = `Device error: ${error.message}`;
          log(`Device error: ${error.message}`);
        });

        device.on("incoming", (conn) => {
          log("Incoming call - auto-accepting");
          activeConnection = conn;
          conn.accept();
          hangupBtn.disabled = false;
        });

        device.on("connect", (conn) => {
          log("Call connected");
          activeConnection = conn;
          hangupBtn.disabled = false;
        });

        device.on("disconnect", () => {
          log("Call disconnected");
          activeConnection = null;
          hangupBtn.disabled = true;
        });

        device.on("cancel", () => {
          log("Call cancelled");
          activeConnection = null;
          hangupBtn.disabled = true;
        });

        statusEl.textContent = "Device initializing...";
      } catch (err) {
        statusEl.textContent = `Init failed: ${err.message}`;
        log(err.message);
      }
    }

    function placeCall() {
      if (!device) {
        log("Device not ready");
        return;
      }
      const to = document.getElementById("dial-to").value.trim();
      log(`Dialing ${to}`);
      activeConnection = device.connect({ params: { To: to } });
      hangupBtn.disabled = false;
    }

    function hangupCall() {
      if (activeConnection) {
        log("Hanging up");
        activeConnection.disconnect();
        activeConnection = null;
      }
    }

    initBtn.onclick = initDevice;
    callBtn.onclick = placeCall;
    hangupBtn.onclick = hangupCall;
  </script>
</body>
</html>
